<a href="https://github.com/learnboost/mongoose"><img alt="Fork me on GitHub" id="ribbon" src="http://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a><html>
	<head>
		<title>Mongoose</title>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
		<style>body {
    margin: 0;
    padding: 0;
    font: 14px/1.5 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    color: #252519;
}
a {
    color: #252519;
}
a:hover {
    text-decoration: underline;
    color: #19469D;
}
p {
    margin: 12px 0;
}
h1, h2, h3 {
    margin: 0;
    padding: 0;
}
table#source {
    width: 100%;
    border-collapse: collapse;
}
table#source td:first-child {
    padding: 30px 40px 30px 40px;
    vertical-align: top;
}
table#source td:first-child,
table#source td:first-child pre {
    width: 450px;
}
table#source td:last-child {
    padding: 30px 0 30px 40px;
    border-left: 1px solid #E5E5EE;
}
table#source tr {
    border-bottom: 1px solid #E5E5EE;
}
table#source tr.filename {
    padding-top: 40px;
    border-top: 1px solid #E5E5EE;
}
table#source tr.filename td {
    background: #F5F5FF;
}
table#source tr.filename td:first-child {
    text-transform: capitalize;
}
table#source tr.filename td:last-child {
    font-size: 12px;
}
table#source tr.filename h2 {
    margin: 0;
    padding: 0;
    cursor: pointer;
}
table#source tr.code h1,
table#source tr.code h2,
table#source tr.code h3 {
    margin-top: 30px;
    font-family: "Lucida Grande", "Helvetica Nueue", Arial, sans-serif;
    font-size: 18px;
}
table#source tr.code h2 {
    font-size: 16px;
}
table#source tr.code h3 {
    font-size: 14px;
}
table#source tr.code ul {
    margin: 15px 0 15px 35px;
    padding: 0;
}
table#source tr.code ul li {
    margin: 0;
    padding: 1px 0;
}
table#source tr.code ul li p {
    margin: 0;
    padding: 0;
}
table#source tr.code td.docs {
  padding-left: 75px;
}
table#source tr.code td:first-child pre {
    padding: 20px;
}
#ribbon {
    position: fixed;
    top: 0;
    right: 0;
}
code .string { color: #219161; }
code .regexp { color: #219161; }
code .keyword { color: #954121; }
code .number { color: #19469D; }
code .comment { color: #bbb; }
code .this { color: #19469D; }
</style>
		<script>
			$(function(){
        $('#source').on('dblclick', 'td', function (e) {
          var td = $(this)
            , tr = td.closest('tr')

          if (tr.is('.filename')) {
            tr.click();
          } else if (tr.is('.code')) {

            tr.prevAll('tr.filename:first').click();
          }
        });

				$('tr.filename').toggle(function(){
					$(this).nextUntil('.filename').fadeOut();
				}, function(){
					$(this).nextUntil('.filename').fadeIn();
				});
			});
		</script>
	</head>
	<body>
<table id="source"><tbody><tr><td><h1>Mongoose</h1><p>Expressive MongoDB for Node.JS</p></td><td></td></tr><tr class="filename"><td><h2 id="lib/collection.js"><a href="#">collection</a></h2></td><td>lib/collection.js</td></tr><tr class="code">
<td class="docs">
<p>Collection constructor</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  collection name</p></li><li><p><strong>param</strong>: <em>Collection</em>  connection object</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">Collection</span> (<span class="variable">name</span>, <span class="variable">conn</span>) {
  <span class="this">this</span>.<span class="variable">name</span> = <span class="variable">name</span>;
  <span class="this">this</span>.<span class="variable">conn</span> = <span class="variable">conn</span>;
  <span class="this">this</span>.<span class="variable">buffer</span> = <span class="variable">true</span>;
  <span class="this">this</span>.<span class="variable">queue</span> = [];
  <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">conn</span>.<span class="variable">readyState</span> == <span class="number integer">1</span>) <span class="this">this</span>.<span class="variable">onOpen</span>();
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>The collection name</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Collection</span>.<span class="variable">prototype</span>.<span class="variable">name</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>The Connection instance</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Collection</span>.<span class="variable">prototype</span>.<span class="variable">conn</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">Collection</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/connection.js"><a href="#">connection</a></h2></td><td>lib/connection.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">url</span> = <span class="variable">require</span>(<span class="string">'url'</span>)
  , <span class="variable">utils</span> = <span class="variable">require</span>(<span class="string">'./utils'</span>)
  , <span class="class">EventEmitter</span> = <span class="variable">utils</span>.<span class="class">EventEmitter</span>
  , <span class="variable">driver</span> = <span class="variable">global</span>.<span class="class">MONGOOSE_DRIVER_PATH</span> || <span class="string">'./drivers/node-mongodb-native'</span>
  , <span class="class">Model</span> = <span class="variable">require</span>(<span class="string">'./model'</span>)
  , <span class="class">Schema</span> = <span class="variable">require</span>(<span class="string">'./schema'</span>)
  , <span class="class">Collection</span>  = <span class="variable">require</span>(<span class="variable">driver</span> + <span class="string">'/collection'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Connection constructor. For practical reasons, a Connection equals a Db</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Mongoose</em>  mongoose base</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">Connection</span> (<span class="variable">base</span>) {
  <span class="this">this</span>.<span class="variable">base</span> = <span class="variable">base</span>;
  <span class="this">this</span>.<span class="variable">collections</span> = {};
  <span class="this">this</span>.<span class="variable">models</span> = {};
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherit from EventEmitter.</p>

<p> </p>
</td>
<td class="code">
<pre><code><span class="class">Connection</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">EventEmitter</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Connection ready state:
 0 = Disconnected
 1 = Connected
 2 = Connecting
 3 = Disconnecting</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Connection</span>.<span class="variable">prototype</span>.<span class="variable">readyState</span> = <span class="number integer">0</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>A hash of the collections associated with this connection
 </p>
</td>
<td class="code">
<pre><code><span class="class">Connection</span>.<span class="variable">prototype</span>.<span class="variable">collections</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>The mongodb.Db instance, set when the connection is opened</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Connection</span>.<span class="variable">prototype</span>.<span class="variable">db</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Establishes the connection</p>

<p> <code>options</code> is a hash with the following optional properties:</p>

<p>  options.db      - passed to the connection db instance
  options.server  - passed to the connection server instance(s)
  options.replset - passed to the connection ReplSetServer instance
  options.user    - username for authentication
  options.pass    - password for authentication</p>

<p>  Notes:</p>

<p>  Mongoose forces the db option <code>forceServerObjectId</code> false and cannot
  be overridden.</p>

<p>  Mongoose defaults the server <code>auto_reconnect</code> options to true which
  can be overridden.</p>

<p>  See the node-mongodb-native driver instance for options that it
  understands.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  mongodb://uri</p></li><li><p><strong>return</strong>: <em>Connection</em>  self</p></li><li><p><strong>see</strong>: <em>https</em>
://github.com/christkv/node-mongodb-native</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Connection</span>.<span class="variable">prototype</span>.<span class="variable">open</span> = <span class="keyword">function</span> (<span class="variable">host</span>, <span class="variable">database</span>, <span class="variable">port</span>, <span class="variable">options</span>, <span class="variable">callback</span>) {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>
    , <span class="variable">uri</span>;

  <span class="keyword">if</span> (<span class="string">'string'</span> === <span class="keyword">typeof</span> <span class="variable">database</span>) {
    <span class="keyword">switch</span> (<span class="variable">arguments</span>.<span class="variable">length</span>) {
      <span class="keyword">case</span> <span class="number integer">2</span>:
        <span class="variable">port</span> = <span class="number integer">27017</span>;
      <span class="keyword">case</span> <span class="number integer">3</span>:
        <span class="keyword">switch</span> (<span class="keyword">typeof</span> <span class="variable">port</span>) {
          <span class="keyword">case</span> <span class="string">'function'</span>:
            <span class="variable">callback</span> = <span class="variable">port</span>, <span class="variable">port</span> = <span class="number integer">27017</span>;
            <span class="keyword">break</span>;
          <span class="keyword">case</span> <span class="string">'object'</span>:
            <span class="variable">options</span> = <span class="variable">port</span>, <span class="variable">port</span> = <span class="number integer">27017</span>;
            <span class="keyword">break</span>;
        }
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="number integer">4</span>:
        <span class="keyword">if</span> (<span class="string">'function'</span> === <span class="keyword">typeof</span> <span class="variable">options</span>)
          <span class="variable">callback</span> = <span class="variable">options</span>, <span class="variable">options</span> = {};
    }
  } <span class="keyword">else</span> {
    <span class="keyword">switch</span> (<span class="keyword">typeof</span> <span class="variable">database</span>) {
      <span class="keyword">case</span> <span class="string">'function'</span>:
        <span class="variable">callback</span> = <span class="variable">database</span>, <span class="variable">database</span> = <span class="variable">undefined</span>;
        <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="string">'object'</span>:
        <span class="variable">options</span> = <span class="variable">database</span>;
        <span class="variable">database</span> = <span class="variable">undefined</span>;
        <span class="variable">callback</span> = <span class="variable">port</span>;
        <span class="keyword">break</span>;
    }

    <span class="variable">uri</span> = <span class="variable">url</span>.<span class="variable">parse</span>(<span class="variable">host</span>);
    <span class="variable">host</span> = <span class="variable">uri</span>.<span class="variable">hostname</span>;
    <span class="variable">port</span> = <span class="variable">uri</span>.<span class="variable">port</span> || <span class="number integer">27017</span>;
    <span class="variable">database</span> = <span class="variable">uri</span>.<span class="variable">pathname</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">uri</span>.<span class="variable">pathname</span>.<span class="variable">replace</span>(<span class="regexp">/\/</span>/<span class="variable">g</span>, <span class="string">''</span>);
  }

  <span class="variable">callback</span> = <span class="variable">callback</span> || <span class="variable">noop</span>;
  <span class="this">this</span>.<span class="variable">options</span> = <span class="this">this</span>.<span class="variable">defaultOptions</span>(<span class="variable">options</span>);

  <span class="comment">// make sure we can open</span>
  <span class="keyword">if</span> (<span class="number integer">0</span> !== <span class="this">this</span>.<span class="variable">readyState</span>) {
    <span class="keyword">var</span> <span class="variable">err</span> = <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Trying to open unclosed connection.'</span>);
    <span class="variable">err</span>.<span class="variable">state</span> = <span class="this">this</span>.<span class="variable">readyState</span>;
    <span class="variable">callback</span>(<span class="variable">err</span>);
    <span class="keyword">return</span> <span class="this">this</span>;
  }

  <span class="keyword">if</span> (!<span class="variable">host</span>) {
    <span class="variable">callback</span>(<span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Missing connection hostname.'</span>));
    <span class="keyword">return</span> <span class="this">this</span>;
  }

  <span class="keyword">if</span> (!<span class="variable">database</span>) {
    <span class="variable">callback</span>(<span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Missing connection database.'</span>));
    <span class="keyword">return</span> <span class="this">this</span>;
  }

  <span class="comment">// handle authentication</span>
  <span class="keyword">if</span> (<span class="variable">uri</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">uri</span>.<span class="variable">auth</span>) {
    <span class="keyword">var</span> <span class="variable">auth</span> = <span class="variable">uri</span>.<span class="variable">auth</span>.<span class="variable">split</span>(<span class="string">':'</span>);
    <span class="this">this</span>.<span class="variable">user</span> = <span class="variable">auth</span>[<span class="number integer">0</span>];
    <span class="this">this</span>.<span class="variable">pass</span> = <span class="variable">auth</span>[<span class="number integer">1</span>];

  <span class="comment">// Check hostname for user/pass</span>
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="regexp">/@/</span>.<span class="variable">test</span>(<span class="variable">host</span>) &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="regexp">/:/</span>.<span class="variable">test</span>(<span class="variable">host</span>.<span class="variable">split</span>(<span class="string">'@'</span>)[<span class="number integer">0</span>])) {
    <span class="variable">host</span> = <span class="variable">host</span>.<span class="variable">split</span>(<span class="string">'@'</span>);
    <span class="keyword">var</span> <span class="variable">auth</span> = <span class="variable">host</span>.<span class="variable">shift</span>().<span class="variable">split</span>(<span class="string">':'</span>);
    <span class="variable">host</span> = <span class="variable">host</span>.<span class="variable">pop</span>();
    <span class="this">this</span>.<span class="variable">user</span> = <span class="variable">auth</span>[<span class="number integer">0</span>];
    <span class="this">this</span>.<span class="variable">pass</span> = <span class="variable">auth</span>[<span class="number integer">1</span>];

  <span class="comment">// user/pass options</span>
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">options</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">options</span>.<span class="variable">user</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">options</span>.<span class="variable">pass</span>) {
    <span class="this">this</span>.<span class="variable">user</span> = <span class="variable">options</span>.<span class="variable">user</span>;
    <span class="this">this</span>.<span class="variable">pass</span> = <span class="variable">options</span>.<span class="variable">pass</span>;

  } <span class="keyword">else</span> {
    <span class="this">this</span>.<span class="variable">user</span> = <span class="this">this</span>.<span class="variable">pass</span> = <span class="variable">undefined</span>;
  }

  <span class="this">this</span>.<span class="variable">name</span> = <span class="variable">database</span>;
  <span class="this">this</span>.<span class="variable">host</span> = <span class="variable">host</span>;
  <span class="this">this</span>.<span class="variable">port</span> = <span class="variable">port</span>;

  <span class="comment">// signal connecting</span>
  <span class="this">this</span>.<span class="variable">readyState</span> = <span class="number integer">2</span>;
  <span class="this">this</span>.<span class="variable">emit</span>(<span class="string">'opening'</span>);

  <span class="comment">// open connection</span>
  <span class="this">this</span>.<span class="variable">doOpen</span>(<span class="keyword">function</span> (<span class="variable">err</span>) {
    <span class="keyword">if</span> (<span class="variable">err</span>) {
      <span class="variable">self</span>.<span class="variable">readyState</span> = <span class="number integer">0</span>;
      <span class="keyword">if</span> (<span class="variable">self</span>.<span class="variable">_events</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">self</span>.<span class="variable">_events</span>.<span class="variable">error</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>;
         (<span class="string">'function'</span> == <span class="keyword">typeof</span> <span class="variable">self</span>.<span class="variable">_events</span>.<span class="variable">error</span> || <span class="variable">self</span>.<span class="variable">_events</span>.<span class="variable">error</span>.<span class="variable">length</span>)) {
        <span class="variable">self</span>.<span class="variable">emit</span>(&<span class="variable">quot</span>;<span class="variable">error</span>&<span class="variable">quot</span>;, <span class="variable">err</span>);
      }
    } <span class="keyword">else</span> {
      <span class="variable">self</span>.<span class="variable">onOpen</span>();
    }

    <span class="variable">callback</span>(<span class="variable">err</span> || <span class="keyword">null</span>);
  });

  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Connects to a replica set.</p>

<p>Supply a comma-separted list of mongodb:// URIs. You only need to specify
the database name and/or auth to one of them.</p>

<p>The options parameter is passed to the low level connection. See the
node-mongodb-native driver instance for detail.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  comma-separated mongodb:// URIs</p></li><li><p><strong>param</strong>: <em>String</em>  optional database name</p></li><li><p><strong>param</strong>: <em>Object</em>  optional options</p></li><li><p><strong>param</strong>: <em>Function</em>  optional callback</p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Connection</span>.<span class="variable">prototype</span>.<span class="variable">openSet</span> = <span class="keyword">function</span> (<span class="variable">uris</span>, <span class="variable">database</span>, <span class="variable">options</span>, <span class="variable">callback</span>) {
  <span class="keyword">var</span> <span class="variable">uris</span> = <span class="variable">uris</span>.<span class="variable">split</span>(<span class="string">','</span>)
    , <span class="variable">self</span> = <span class="this">this</span>;

  <span class="keyword">switch</span> (<span class="variable">arguments</span>.<span class="variable">length</span>) {
    <span class="keyword">case</span> <span class="number integer">3</span>:
      <span class="this">this</span>.<span class="variable">name</span> = <span class="variable">database</span>;
      <span class="keyword">if</span> (<span class="string">'function'</span> === <span class="keyword">typeof</span> <span class="variable">options</span>) <span class="variable">callback</span> = <span class="variable">options</span>, <span class="variable">options</span> = {};
      <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="number integer">2</span>:
      <span class="keyword">switch</span> (<span class="keyword">typeof</span> <span class="variable">database</span>) {
        <span class="keyword">case</span> <span class="string">'string'</span>:
          <span class="this">this</span>.<span class="variable">name</span> = <span class="variable">database</span>;
        <span class="keyword">case</span> <span class="string">'function'</span>:
          <span class="variable">callback</span> = <span class="variable">database</span>, <span class="variable">database</span> = <span class="keyword">null</span>;
          <span class="keyword">break</span>;
        <span class="keyword">case</span> <span class="string">'object'</span>:
          <span class="variable">options</span> = <span class="variable">database</span>, <span class="variable">database</span> = <span class="keyword">null</span>;
          <span class="keyword">break</span>;
      }
  }

  <span class="this">this</span>.<span class="variable">options</span> = <span class="variable">options</span> = <span class="this">this</span>.<span class="variable">defaultOptions</span>(<span class="variable">options</span>);
  <span class="variable">callback</span> = <span class="variable">callback</span> || <span class="variable">noop</span>;

  <span class="keyword">if</span> (<span class="variable">uris</span>.<span class="variable">length</span> &<span class="variable">lt</span>; <span class="number integer">2</span>) {
    <span class="variable">callback</span>(<span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Please provide comma-separated URIs'</span>));
    <span class="keyword">return</span> <span class="this">this</span>;
  }

  <span class="this">this</span>.<span class="variable">host</span> = [];
  <span class="this">this</span>.<span class="variable">port</span> = [];

  <span class="variable">uris</span>.<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">uri</span>) {
    <span class="keyword">var</span> <span class="variable">uri</span> = <span class="variable">url</span>.<span class="variable">parse</span>(<span class="variable">uri</span>);

    <span class="variable">self</span>.<span class="variable">host</span>.<span class="variable">push</span>(<span class="variable">uri</span>.<span class="variable">hostname</span>);
    <span class="variable">self</span>.<span class="variable">port</span>.<span class="variable">push</span>(<span class="variable">uri</span>.<span class="variable">port</span> || <span class="number integer">27017</span>);

    <span class="keyword">if</span> (!<span class="variable">self</span>.<span class="variable">name</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">uri</span>.<span class="variable">pathname</span>.<span class="variable">replace</span>(<span class="regexp">/\/</span>/<span class="variable">g</span>, <span class="string">''</span>))
      <span class="variable">self</span>.<span class="variable">name</span> = <span class="variable">uri</span>.<span class="variable">pathname</span>.<span class="variable">replace</span>(<span class="regexp">/\/</span>/<span class="variable">g</span>, <span class="string">''</span>);

    <span class="keyword">if</span> (!<span class="variable">self</span>.<span class="variable">user</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">uri</span>.<span class="variable">auth</span>) {
      <span class="keyword">var</span> <span class="variable">auth</span> = <span class="variable">uri</span>.<span class="variable">auth</span>.<span class="variable">split</span>(<span class="string">':'</span>);
      <span class="variable">self</span>.<span class="variable">user</span> = <span class="variable">auth</span>[<span class="number integer">0</span>];
      <span class="variable">self</span>.<span class="variable">pass</span> = <span class="variable">auth</span>[<span class="number integer">1</span>];
    }
  });

  <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">name</span>) {
    <span class="variable">callback</span>(<span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'No database name provided for replica set'</span>));
    <span class="keyword">return</span> <span class="this">this</span>;
  }

  <span class="this">this</span>.<span class="variable">readyState</span> = <span class="number integer">2</span>;
  <span class="this">this</span>.<span class="variable">emit</span>(<span class="string">'opening'</span>);

  <span class="comment">// open connection</span>
  <span class="this">this</span>.<span class="variable">doOpenSet</span>(<span class="keyword">function</span> (<span class="variable">err</span>) {
    <span class="keyword">if</span> (<span class="variable">err</span>) {
      <span class="keyword">if</span> (<span class="variable">self</span>.<span class="variable">_events</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">self</span>.<span class="variable">_events</span>.<span class="variable">error</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">self</span>.<span class="variable">_events</span>.<span class="variable">error</span>.<span class="variable">length</span>) {
        <span class="variable">self</span>.<span class="variable">emit</span>(&<span class="variable">quot</span>;<span class="variable">error</span>&<span class="variable">quot</span>;, <span class="variable">err</span>);
      }
      <span class="variable">self</span>.<span class="variable">readyState</span> = <span class="number integer">0</span>;
    } <span class="keyword">else</span> {
      <span class="variable">self</span>.<span class="variable">onOpen</span>();
    }

    <span class="variable">callback</span>(<span class="variable">err</span> || <span class="keyword">null</span>);
  });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Closes the connection</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  optional callback</p></li><li><p><strong>return</strong>: <em>Connection</em>  self</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Connection</span>.<span class="variable">prototype</span>.<span class="variable">close</span> = <span class="keyword">function</span> (<span class="variable">callback</span>) {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>
    , <span class="variable">callback</span> = <span class="variable">callback</span> || <span class="keyword">function</span>(){};

  <span class="keyword">switch</span> (<span class="this">this</span>.<span class="variable">readyState</span>){
    <span class="keyword">case</span> <span class="number integer">0</span>: <span class="comment">// disconnected</span>
      <span class="variable">callback</span>(<span class="keyword">null</span>);
      <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="number integer">1</span>: <span class="comment">// connected</span>
      <span class="this">this</span>.<span class="variable">readyState</span> = <span class="number integer">3</span>;
      <span class="this">this</span>.<span class="variable">doClose</span>(<span class="keyword">function</span>(<span class="variable">err</span>){
        <span class="keyword">if</span> (<span class="variable">err</span>){
          <span class="variable">callback</span>(<span class="variable">err</span>);
        } <span class="keyword">else</span> {
          <span class="variable">self</span>.<span class="variable">onClose</span>();
          <span class="variable">callback</span>(<span class="keyword">null</span>);
        }
      });
      <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="number integer">2</span>: <span class="comment">// connecting</span>
      <span class="this">this</span>.<span class="variable">once</span>(<span class="string">'open'</span>, <span class="keyword">function</span>(){
        <span class="variable">self</span>.<span class="variable">close</span>(<span class="variable">callback</span>);
      });
      <span class="keyword">break</span>;

    <span class="keyword">case</span> <span class="number integer">3</span>: <span class="comment">// disconnecting</span>
      <span class="this">this</span>.<span class="variable">once</span>(<span class="string">'close'</span>, <span class="keyword">function</span> () {
        <span class="variable">callback</span>(<span class="keyword">null</span>);
      });
      <span class="keyword">break</span>;
  }

  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Retrieves a collection, creating it if not cached.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  collection name</p></li><li><p><strong>return</strong>: <em>Collection</em>  collection instance</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Connection</span>.<span class="variable">prototype</span>.<span class="variable">collection</span> = <span class="keyword">function</span> (<span class="variable">name</span>) {
  <span class="keyword">if</span> (!(<span class="variable">name</span> <span class="keyword">in</span> <span class="this">this</span>.<span class="variable">collections</span>))
    <span class="this">this</span>.<span class="variable">collections</span>[<span class="variable">name</span>] = <span class="keyword">new</span> <span class="class">Collection</span>(<span class="variable">name</span>, <span class="this">this</span>);
  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">collections</span>[<span class="variable">name</span>];
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Defines a model or retrieves it</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  model name</p></li><li><p><strong>param</strong>: <em>Schema</em>  schema object</p></li><li><p><strong>param</strong>: <em>String</em>  collection name (optional, induced from model name)</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Connection</span>.<span class="variable">prototype</span>.<span class="variable">model</span> = <span class="keyword">function</span> (<span class="variable">name</span>, <span class="variable">schema</span>, <span class="variable">collection</span>) {
  <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">models</span>[<span class="variable">name</span>]) {
    <span class="keyword">var</span> <span class="variable">model</span> = <span class="this">this</span>.<span class="variable">base</span>.<span class="variable">model</span>(<span class="variable">name</span>, <span class="variable">schema</span>, <span class="variable">collection</span>, <span class="variable">true</span>)
      , <span class="class">Model</span>

    <span class="keyword">if</span> (<span class="this">this</span> != <span class="variable">model</span>.<span class="variable">prototype</span>.<span class="variable">db</span>) {
      <span class="comment">// subclass model using this connection and collection name</span>
      <span class="class">Model</span> = <span class="keyword">function</span> <span class="class">Model</span> () {
        <span class="variable">model</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">arguments</span>);
      };

      <span class="class">Model</span>.<span class="variable">__proto__</span> = <span class="variable">model</span>;
      <span class="class">Model</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="variable">model</span>.<span class="variable">prototype</span>;
      <span class="class">Model</span>.<span class="variable">prototype</span>.<span class="variable">db</span> = <span class="this">this</span>;

      <span class="comment">// collection name discovery</span>
      <span class="keyword">if</span> (<span class="string">'string'</span> === <span class="keyword">typeof</span> <span class="variable">schema</span>) {
        <span class="variable">collection</span> = <span class="variable">schema</span>;
      }

      <span class="keyword">if</span> (!<span class="variable">collection</span>) {
        <span class="variable">collection</span> = <span class="variable">model</span>.<span class="variable">prototype</span>.<span class="variable">schema</span>.<span class="variable">set</span>(<span class="string">'collection'</span>) || <span class="variable">utils</span>.<span class="variable">toCollectionName</span>(<span class="variable">name</span>);
      }

      <span class="class">Model</span>.<span class="variable">prototype</span>.<span class="variable">collection</span> = <span class="this">this</span>.<span class="variable">collection</span>(<span class="variable">collection</span>);
      <span class="class">Model</span>.<span class="variable">init</span>();
    }

    <span class="this">this</span>.<span class="variable">models</span>[<span class="variable">name</span>] = <span class="class">Model</span> || <span class="variable">model</span>;
  }

  <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">models</span>[<span class="variable">name</span>];
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Set profiling level.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Int | String</em>  level - Either off (0), slow (1), or all (2)</p></li><li><p><strong>param</strong>: <em>Int</em>  [ms]  If profiling <code>level</code> is set to 1, this determines</p><pre><code>           the threshold in milliseconds above which queries
           will be logged. Defaults to 100. (optional)</code></pre></li><li><p><strong>param</strong>: <em>Function</em>  callback</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Connection</span>.<span class="variable">prototype</span>.<span class="variable">setProfiling</span> = <span class="keyword">function</span> (<span class="variable">level</span>, <span class="variable">ms</span>, <span class="variable">callback</span>) {
  <span class="keyword">if</span> (<span class="number integer">1</span> !== <span class="this">this</span>.<span class="variable">readyState</span>) {
    <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">on</span>(<span class="string">'open'</span>, <span class="this">this</span>.<span class="variable">setProfiling</span>.<span class="variable">bind</span>(<span class="this">this</span>, <span class="variable">level</span>, <span class="variable">ms</span>, <span class="variable">callback</span>));
  }

  <span class="keyword">if</span> (!<span class="variable">callback</span>) <span class="variable">callback</span> = <span class="variable">ms</span>, <span class="variable">ms</span> = <span class="number integer">100</span>;

  <span class="keyword">var</span> <span class="variable">cmd</span> = {};

  <span class="keyword">switch</span> (<span class="variable">level</span>) {
    <span class="keyword">case</span> <span class="number integer">0</span>:
    <span class="keyword">case</span> <span class="string">'off'</span>:
      <span class="variable">cmd</span>.<span class="variable">profile</span> = <span class="number integer">0</span>;
      <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="number integer">1</span>:
    <span class="keyword">case</span> <span class="string">'slow'</span>:
      <span class="variable">cmd</span>.<span class="variable">profile</span> = <span class="number integer">1</span>;
      <span class="keyword">if</span> (<span class="string">'number'</span> !== <span class="keyword">typeof</span> <span class="variable">ms</span>) {
        <span class="variable">ms</span> = <span class="variable">parseInt</span>(<span class="variable">ms</span>, <span class="number integer">10</span>);
        <span class="keyword">if</span> (<span class="variable">isNaN</span>(<span class="variable">ms</span>)) <span class="variable">ms</span> = <span class="number integer">100</span>;
      }
      <span class="variable">cmd</span>.<span class="variable">slowms</span> = <span class="variable">ms</span>;
      <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="number integer">2</span>:
    <span class="keyword">case</span> <span class="string">'all'</span>:
      <span class="variable">cmd</span>.<span class="variable">profile</span> = <span class="number integer">2</span>;
      <span class="keyword">break</span>;
    <span class="keyword">default</span>:
      <span class="keyword">return</span> <span class="variable">callback</span>(<span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Invalid profiling level: '</span>+ <span class="variable">level</span>));
  }

  <span class="this">this</span>.<span class="variable">db</span>.<span class="variable">executeDbCommand</span>(<span class="variable">cmd</span>, <span class="keyword">function</span> (<span class="variable">err</span>, <span class="variable">resp</span>) {
    <span class="keyword">if</span> (<span class="variable">err</span>) <span class="keyword">return</span> <span class="variable">callback</span>(<span class="variable">err</span>);

    <span class="keyword">var</span> <span class="variable">doc</span> = <span class="variable">resp</span>.<span class="variable">documents</span>[<span class="number integer">0</span>];

    <span class="variable">err</span> = <span class="number integer">1</span> === <span class="variable">doc</span>.<span class="variable">ok</span>
      ? <span class="keyword">null</span>
      : <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Could not set profiling level to: '</span>+ <span class="variable">level</span>)

    <span class="variable">callback</span>(<span class="variable">err</span>, <span class="variable">doc</span>);
  });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Noop.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">noop</span> () {}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module exports.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">Connection</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/document.js"><a href="#">document</a></h2></td><td>lib/document.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="class">EventEmitter</span> = <span class="variable">require</span>(<span class="string">'events'</span>).<span class="class">EventEmitter</span>
  , <span class="class">MongooseError</span> = <span class="variable">require</span>(<span class="string">'./error'</span>)
  , <span class="class">MixedSchema</span> = <span class="variable">require</span>(<span class="string">'./schema/mixed'</span>)
  , <span class="class">Schema</span> = <span class="variable">require</span>(<span class="string">'./schema'</span>)
  , <span class="class">ValidatorError</span> = <span class="variable">require</span>(<span class="string">'./schematype'</span>).<span class="class">ValidatorError</span>
  , <span class="variable">utils</span> = <span class="variable">require</span>(<span class="string">'./utils'</span>)
  , <span class="variable">clone</span> = <span class="variable">utils</span>.<span class="variable">clone</span>
  , <span class="variable">isMongooseObject</span> = <span class="variable">utils</span>.<span class="variable">isMongooseObject</span>
  , <span class="variable">inspect</span> = <span class="variable">require</span>(<span class="string">'util'</span>).<span class="variable">inspect</span>
  , <span class="class">StateMachine</span> = <span class="variable">require</span>(<span class="string">'./statemachine'</span>)
  , <span class="class">ActiveRoster</span> = <span class="class">StateMachine</span>.<span class="variable">ctor</span>(<span class="string">'require'</span>, <span class="string">'modify'</span>, <span class="string">'init'</span>, <span class="string">'default'</span>)
  , <span class="variable">deepEqual</span> = <span class="variable">utils</span>.<span class="variable">deepEqual</span>
  , <span class="variable">hooks</span> = <span class="variable">require</span>(<span class="string">'hooks'</span>)
  , <span class="class">DocumentArray</span></code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Inherit from EventEmitter.
 </p>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">__proto__</span> = <span class="class">EventEmitter</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Base Mongoose instance for the model. Set by the Mongoose instance upon
pre-compilation.</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">base</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Document schema as a nested structure.</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">schema</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Whether the document is new.</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">isNew</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Validation errors.</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">errors</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Sets a path, or many paths</p>

<h2>Examples</h2>

<pre><code>// path, value
doc.set(path, value)

// object
doc.set({
    path  : value
  , path2 : {
       path  : value
    }
}</code></pre>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String | Object</em>  key path, or object</p></li><li><p><strong>param</strong>: <em>Object</em>  value, or undefined or a prefix if first parameter is an object</p></li><li><p><strong>para</strong>: <em>m</em>
@optional {Schema|String|...} specify a type if this is an on-the-fly attribute</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">set</span> = <span class="keyword">function</span> (<span class="variable">path</span>, <span class="variable">val</span>, <span class="variable">type</span>) {
  <span class="keyword">var</span> <span class="variable">constructing</span> = <span class="variable">true</span> === <span class="variable">type</span>
    , <span class="variable">adhoc</span> = <span class="variable">type</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">true</span> !== <span class="variable">type</span>
    , <span class="variable">adhocs</span>

  <span class="keyword">if</span> (<span class="variable">adhoc</span>) {
    <span class="variable">adhocs</span> = <span class="this">this</span>.<span class="variable">_adhocPaths</span> || (<span class="this">this</span>.<span class="variable">_adhocPaths</span> = {});
    <span class="variable">adhocs</span>[<span class="variable">path</span>] = <span class="class">Schema</span>.<span class="variable">interpretAsType</span>(<span class="variable">path</span>, <span class="variable">type</span>);
  }

  <span class="keyword">if</span> (<span class="string">'string'</span> !== <span class="keyword">typeof</span> <span class="variable">path</span>) {
    <span class="comment">// new Document({ key: val })</span>

    <span class="keyword">if</span> (<span class="keyword">null</span> === <span class="variable">path</span> || <span class="variable">undefined</span> === <span class="variable">path</span>) {
      <span class="keyword">var</span> <span class="variable">_</span> = <span class="variable">path</span>;
      <span class="variable">path</span> = <span class="variable">val</span>;
      <span class="variable">val</span> = <span class="variable">_</span>;

    } <span class="keyword">else</span> {
      <span class="keyword">var</span> <span class="variable">prefix</span> = <span class="variable">val</span>
        ? <span class="variable">val</span> + <span class="string">'.'</span>
        : <span class="string">''</span>;

      <span class="keyword">if</span> (<span class="variable">path</span> <span class="variable">instanceof</span> <span class="class">Document</span>) <span class="variable">path</span> = <span class="variable">path</span>.<span class="variable">_doc</span>;

      <span class="keyword">var</span> <span class="variable">keys</span> = <span class="class">Object</span>.<span class="variable">keys</span>(<span class="variable">path</span>)
        , <span class="variable">i</span> = <span class="variable">keys</span>.<span class="variable">length</span>
        , <span class="variable">pathtype</span>
        , <span class="variable">key</span>

      <span class="keyword">while</span> (<span class="variable">i</span>--) {
        <span class="variable">key</span> = <span class="variable">keys</span>[<span class="variable">i</span>];
        <span class="keyword">if</span> (<span class="keyword">null</span> != <span class="variable">path</span>[<span class="variable">key</span>] &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="string">'Object'</span> === <span class="variable">path</span>[<span class="variable">key</span>].<span class="variable">constructor</span>.<span class="variable">name</span>
          &<span class="variable">amp</span>;&<span class="variable">amp</span>; !(<span class="this">this</span>.<span class="variable">_path</span>(<span class="variable">prefix</span> + <span class="variable">key</span>) <span class="variable">instanceof</span> <span class="class">MixedSchema</span>)) {
          <span class="this">this</span>.<span class="variable">set</span>(<span class="variable">path</span>[<span class="variable">key</span>], <span class="variable">prefix</span> + <span class="variable">key</span>, <span class="variable">constructing</span>);
        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">_strictMode</span>) {
          <span class="variable">pathtype</span> = <span class="this">this</span>.<span class="variable">schema</span>.<span class="variable">pathType</span>(<span class="variable">prefix</span> + <span class="variable">key</span>);
          <span class="keyword">if</span> (<span class="string">'real'</span> === <span class="variable">pathtype</span> || <span class="string">'virtual'</span> === <span class="variable">pathtype</span>) {
            <span class="this">this</span>.<span class="variable">set</span>(<span class="variable">prefix</span> + <span class="variable">key</span>, <span class="variable">path</span>[<span class="variable">key</span>], <span class="variable">constructing</span>);
          }
        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">undefined</span> !== <span class="variable">path</span>[<span class="variable">key</span>]) {
          <span class="this">this</span>.<span class="variable">set</span>(<span class="variable">prefix</span> + <span class="variable">key</span>, <span class="variable">path</span>[<span class="variable">key</span>], <span class="variable">constructing</span>);
        }
      }

      <span class="keyword">return</span> <span class="this">this</span>;
    }
  }

  <span class="comment">// ensure _strict is honored for obj props</span>
  <span class="comment">// docschema = new Schema({ path: { nest: 'string' }})</span>
  <span class="comment">// doc.set('path', obj);</span>
  <span class="keyword">var</span> <span class="variable">pathType</span> = <span class="this">this</span>.<span class="variable">schema</span>.<span class="variable">pathType</span>(<span class="variable">path</span>);
  <span class="keyword">if</span> (<span class="string">'nested'</span> == <span class="variable">pathType</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">val</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="string">'Object'</span> == <span class="variable">val</span>.<span class="variable">constructor</span>.<span class="variable">name</span>) {
    <span class="this">this</span>.<span class="variable">set</span>(<span class="variable">val</span>, <span class="variable">path</span>, <span class="variable">constructing</span>);
    <span class="keyword">return</span> <span class="this">this</span>;
  }

  <span class="keyword">var</span> <span class="variable">schema</span>;
  <span class="keyword">if</span> (<span class="string">'adhocOrUndefined'</span> == <span class="variable">pathType</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="this">this</span>.<span class="variable">_strictMode</span>) {
    <span class="keyword">return</span> <span class="this">this</span>;
  } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'virtual'</span> == <span class="variable">pathType</span>) {
    <span class="variable">schema</span> = <span class="this">this</span>.<span class="variable">schema</span>.<span class="variable">virtualpath</span>(<span class="variable">path</span>);
    <span class="variable">schema</span>.<span class="variable">applySetters</span>(<span class="variable">val</span>, <span class="this">this</span>);
    <span class="keyword">return</span> <span class="this">this</span>;
  } <span class="keyword">else</span> {
    <span class="variable">schema</span> = <span class="this">this</span>.<span class="variable">_path</span>(<span class="variable">path</span>);
  }

  <span class="keyword">var</span> <span class="variable">parts</span> = <span class="variable">path</span>.<span class="variable">split</span>(<span class="string">'.'</span>)
    , <span class="variable">obj</span> = <span class="this">this</span>.<span class="variable">_doc</span>
    , <span class="variable">self</span> = <span class="this">this</span>
    , <span class="variable">pathToMark</span>
    , <span class="variable">subpaths</span>
    , <span class="variable">subpath</span>

  <span class="comment">// When using the $set operator the path to the field must already exist.</span>
  <span class="comment">// Else mongodb throws: &quot;LEFT_SUBFIELD only supports Object&quot;</span>

  <span class="keyword">if</span> (<span class="variable">parts</span>.<span class="variable">length</span> &<span class="variable">lt</span>;= <span class="number integer">1</span>) {
    <span class="variable">pathToMark</span> = <span class="variable">path</span>;
  } <span class="keyword">else</span> {
    <span class="variable">subpaths</span> = <span class="variable">parts</span>.<span class="variable">map</span>(<span class="keyword">function</span> (<span class="variable">part</span>, <span class="variable">i</span>) {
      <span class="keyword">return</span> <span class="variable">parts</span>.<span class="variable">slice</span>(<span class="number integer">0</span>, <span class="variable">i</span>).<span class="variable">concat</span>(<span class="variable">part</span>).<span class="variable">join</span>(<span class="string">'.'</span>);
    });

    <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="variable">subpaths</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>; <span class="variable">i</span>++) {
      <span class="variable">subpath</span> = <span class="variable">subpaths</span>[<span class="variable">i</span>];
      <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">isDirectModified</span>(<span class="variable">subpath</span>) <span class="comment">// earlier prefixes that are already</span>
                                         <span class="comment">// marked as dirty have precedence</span>
          || <span class="this">this</span>.<span class="variable">get</span>(<span class="variable">subpath</span>) === <span class="keyword">null</span>) {
        <span class="variable">pathToMark</span> = <span class="variable">subpath</span>;
        <span class="keyword">break</span>;
      }
    }

    <span class="keyword">if</span> (!<span class="variable">pathToMark</span>) <span class="variable">pathToMark</span> = <span class="variable">path</span>;
  }

  <span class="keyword">if</span> ((!<span class="variable">schema</span> || <span class="keyword">null</span> === <span class="variable">val</span> || <span class="variable">undefined</span> === <span class="variable">val</span>) ||
    <span class="this">this</span>.<span class="keyword">try</span>(<span class="keyword">function</span>(){
      <span class="comment">// if this doc is being constructed we should not</span>
      <span class="comment">// trigger getters.</span>
      <span class="keyword">var</span> <span class="variable">cur</span> = <span class="variable">constructing</span> ? <span class="variable">undefined</span> : <span class="variable">self</span>.<span class="variable">get</span>(<span class="variable">path</span>);
      <span class="keyword">var</span> <span class="variable">casted</span> = <span class="variable">schema</span>.<span class="variable">cast</span>(<span class="variable">val</span>, <span class="variable">self</span>, <span class="variable">false</span>, <span class="variable">cur</span>);
      <span class="variable">val</span> = <span class="variable">schema</span>.<span class="variable">applySetters</span>(<span class="variable">casted</span>, <span class="variable">self</span>);
    })) {

    <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">isNew</span>) {
      <span class="this">this</span>.<span class="variable">markModified</span>(<span class="variable">pathToMark</span>);
    } <span class="keyword">else</span> {
      <span class="keyword">var</span> <span class="variable">priorVal</span> = <span class="this">this</span>.<span class="variable">get</span>(<span class="variable">path</span>);

      <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">isDirectModified</span>(<span class="variable">pathToMark</span>)) {
        <span class="keyword">if</span> (<span class="variable">undefined</span> === <span class="variable">val</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; !<span class="this">this</span>.<span class="variable">isSelected</span>(<span class="variable">path</span>)) {
          <span class="comment">// special case:</span>
          <span class="comment">// when a path is not selected in a query its initial</span>
          <span class="comment">// value will be undefined.</span>
          <span class="this">this</span>.<span class="variable">markModified</span>(<span class="variable">pathToMark</span>);
        } <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="variable">deepEqual</span>(<span class="variable">val</span>, <span class="variable">priorVal</span>)) {
          <span class="this">this</span>.<span class="variable">markModified</span>(<span class="variable">pathToMark</span>);
        } <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="variable">constructing</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>;
                   <span class="keyword">null</span> != <span class="variable">val</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>;
                   <span class="variable">path</span> <span class="keyword">in</span> <span class="this">this</span>.<span class="variable">_activePaths</span>.<span class="variable">states</span>.<span class="keyword">default</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>;
                   <span class="variable">deepEqual</span>(<span class="variable">val</span>, <span class="variable">schema</span>.<span class="variable">getDefault</span>(<span class="this">this</span>, <span class="variable">constructing</span>))) {
          <span class="comment">// special case:</span>
          <span class="comment">// a path with a default was $unset on the server</span>
          <span class="comment">// and the user is setting it to the same value again</span>
          <span class="this">this</span>.<span class="variable">markModified</span>(<span class="variable">pathToMark</span>);
        }
      }
    }

    <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="variable">parts</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>; <span class="variable">i</span>++) {
      <span class="keyword">var</span> <span class="variable">next</span> = <span class="variable">i</span> + <span class="number integer">1</span>
        , <span class="variable">last</span> = <span class="variable">next</span> === <span class="variable">l</span>;

      <span class="keyword">if</span> (<span class="variable">last</span>) {
        <span class="variable">obj</span>[<span class="variable">parts</span>[<span class="variable">i</span>]] = <span class="variable">val</span>;
      } <span class="keyword">else</span> {
        <span class="keyword">if</span> (<span class="variable">obj</span>[<span class="variable">parts</span>[<span class="variable">i</span>]] &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="string">'Object'</span> === <span class="variable">obj</span>[<span class="variable">parts</span>[<span class="variable">i</span>]].<span class="variable">constructor</span>.<span class="variable">name</span>) {
          <span class="variable">obj</span> = <span class="variable">obj</span>[<span class="variable">parts</span>[<span class="variable">i</span>]];
        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">obj</span>[<span class="variable">parts</span>[<span class="variable">i</span>]] &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="class">Array</span>.<span class="variable">isArray</span>(<span class="variable">obj</span>[<span class="variable">parts</span>[<span class="variable">i</span>]])) {
          <span class="variable">obj</span> = <span class="variable">obj</span>[<span class="variable">parts</span>[<span class="variable">i</span>]];
        } <span class="keyword">else</span> {
          <span class="variable">obj</span> = <span class="variable">obj</span>[<span class="variable">parts</span>[<span class="variable">i</span>]] = {};
        }
      }
    }
  }

  <span class="keyword">return</span> <span class="this">this</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Triggers casting on a specific path</p>

<ul><li><strong>tod</strong>: <em>o</em></li><li><p>deprecate? not used anywhere
## </p></li><li><p><strong>param</strong>: <em>String</em>  path</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">doCast</span> = <span class="keyword">function</span> (<span class="variable">path</span>) {
  <span class="keyword">var</span> <span class="variable">schema</span> = <span class="this">this</span>.<span class="variable">schema</span>.<span class="variable">path</span>(<span class="variable">path</span>);
  <span class="keyword">if</span> (<span class="variable">schema</span>)
    <span class="this">this</span>.<span class="variable">setValue</span>(<span class="variable">path</span>, <span class="this">this</span>.<span class="variable">getValue</span>(<span class="variable">path</span>));
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Gets a path</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  key path</p></li><li><p><strong>para</strong>: <em>m</em>
@optional {Schema|String|...} specify a type if this is an on-the-fly attribute</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">get</span> = <span class="keyword">function</span> (<span class="variable">path</span>, <span class="variable">type</span>) {
  <span class="keyword">var</span> <span class="variable">adhocs</span>;
  <span class="keyword">if</span> (<span class="variable">type</span>) {
    <span class="variable">adhocs</span> = <span class="this">this</span>.<span class="variable">_adhocPaths</span> || (<span class="this">this</span>.<span class="variable">_adhocPaths</span> = {});
    <span class="variable">adhocs</span>[<span class="variable">path</span>] = <span class="class">Schema</span>.<span class="variable">interpretAsType</span>(<span class="variable">path</span>, <span class="variable">type</span>);
  }

  <span class="keyword">var</span> <span class="variable">schema</span> = <span class="this">this</span>.<span class="variable">_path</span>(<span class="variable">path</span>) || <span class="this">this</span>.<span class="variable">schema</span>.<span class="variable">virtualpath</span>(<span class="variable">path</span>)
    , <span class="variable">pieces</span> = <span class="variable">path</span>.<span class="variable">split</span>(<span class="string">'.'</span>)
    , <span class="variable">obj</span> = <span class="this">this</span>.<span class="variable">_doc</span>;

  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="variable">pieces</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>; <span class="variable">i</span>++) {
    <span class="variable">obj</span> = <span class="keyword">null</span> == <span class="variable">obj</span> ? <span class="keyword">null</span> : <span class="variable">obj</span>[<span class="variable">pieces</span>[<span class="variable">i</span>]];
  }

  <span class="keyword">if</span> (<span class="variable">schema</span>) {
    <span class="variable">obj</span> = <span class="variable">schema</span>.<span class="variable">applyGetters</span>(<span class="variable">obj</span>, <span class="this">this</span>);
  }

  <span class="keyword">return</span> <span class="variable">obj</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Commits a path, marking as modified if needed. Useful for mixed keys</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">markModified</span> = <span class="keyword">function</span> (<span class="variable">path</span>) {
  <span class="this">this</span>.<span class="variable">_activePaths</span>.<span class="variable">modify</span>(<span class="variable">path</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>commit</p>

<p>Alias on markModified</p>

<ul><li><p><strong>deprecate</strong>: <em>d</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">commit</span> =
  <span class="variable">utils</span>.<span class="variable">dep</span>(<span class="string">'Document#commit'</span>
          , <span class="string">'Document#markModified'</span>
          , <span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">markModified</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Captures an exception that will be bubbled to <code>save</code></p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  function to execute</p></li><li><p><strong>param</strong>: <em>Object</em>  scope</p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="keyword">try</span> = <span class="keyword">function</span> (<span class="variable">fn</span>, <span class="variable">scope</span>) {
  <span class="keyword">var</span> <span class="variable">res</span>;
  <span class="keyword">try</span> {
    <span class="variable">fn</span>.<span class="variable">call</span>(<span class="variable">scope</span>);
    <span class="variable">res</span> = <span class="variable">true</span>;
  } <span class="keyword">catch</span> (<span class="variable">e</span>) {
    <span class="this">this</span>.<span class="variable">error</span>(<span class="variable">e</span>);
    <span class="variable">res</span> = <span class="variable">false</span>;
  }
  <span class="keyword">return</span> <span class="variable">res</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>modifiedPaths</p>

<p>Returns the list of paths that have been modified.</p>

<p>If we set <code>documents.0.title</code> to 'newTitle'
then <code>documents</code>, <code>documents.0</code>, and <code>documents.0.title</code>
are modified.</p>

<ul><li><p><strong>api</strong>: <em>public</em></p></li><li><p><strong>returns</strong>: <em>Boolean</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">__defineGetter__</span>(<span class="string">'modifiedPaths'</span>, <span class="keyword">function</span> () {
  <span class="keyword">var</span> <span class="variable">directModifiedPaths</span> = <span class="class">Object</span>.<span class="variable">keys</span>(<span class="this">this</span>.<span class="variable">_activePaths</span>.<span class="variable">states</span>.<span class="variable">modify</span>);

  <span class="keyword">return</span> <span class="variable">directModifiedPaths</span>.<span class="variable">reduce</span>(<span class="keyword">function</span> (<span class="variable">list</span>, <span class="variable">path</span>) {
    <span class="keyword">var</span> <span class="variable">parts</span> = <span class="variable">path</span>.<span class="variable">split</span>(<span class="string">'.'</span>);
    <span class="keyword">return</span> <span class="variable">list</span>.<span class="variable">concat</span>(<span class="variable">parts</span>.<span class="variable">reduce</span>(<span class="keyword">function</span> (<span class="variable">chains</span>, <span class="variable">part</span>, <span class="variable">i</span>) {
      <span class="keyword">return</span> <span class="variable">chains</span>.<span class="variable">concat</span>(<span class="variable">parts</span>.<span class="variable">slice</span>(<span class="number integer">0</span>, <span class="variable">i</span>).<span class="variable">concat</span>(<span class="variable">part</span>).<span class="variable">join</span>(<span class="string">'.'</span>));
    }, []));
  }, []);
});</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Checks if a path or any full path containing path as part of
its path chain has been directly modified.</p>

<p>e.g., if we set <code>documents.0.title</code> to 'newTitle'
      then we have directly modified <code>documents.0.title</code>
      but not directly modified <code>documents</code> or <code>documents.0</code>.
      Nonetheless, we still say <code>documents</code> and <code>documents.0</code>
      are modified. They just are not considered direct modified.
      The distinction is important because we need to distinguish
      between what has been directly modified and what hasn't so
      that we can determine the MINIMUM set of dirty data
      that we want to send to MongoDB on a Document save.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  path</p></li><li><p><strong>returns</strong>: <em>Boolean</em></p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">isModified</span> = <span class="keyword">function</span> (<span class="variable">path</span>) {
  <span class="keyword">return</span> !!~<span class="this">this</span>.<span class="variable">modifiedPaths</span>.<span class="variable">indexOf</span>(<span class="variable">path</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Checks if a path has been directly set and modified. False if
the path is only part of a larger path that was directly set.</p>

<p>e.g., if we set <code>documents.0.title</code> to 'newTitle'
      then we have directly modified <code>documents.0.title</code>
      but not directly modified <code>documents</code> or <code>documents.0</code>.
      Nonetheless, we still say <code>documents</code> and <code>documents.0</code>
      are modified. They just are not considered direct modified.
      The distinction is important because we need to distinguish
      between what has been directly modified and what hasn't so
      that we can determine the MINIMUM set of dirty data
      that we want to send to MongoDB on a Document save.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  path</p></li><li><p><strong>returns</strong>: <em>Boolean</em></p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">isDirectModified</span> = <span class="keyword">function</span> (<span class="variable">path</span>) {
  <span class="keyword">return</span> (<span class="variable">path</span> <span class="keyword">in</span> <span class="this">this</span>.<span class="variable">_activePaths</span>.<span class="variable">states</span>.<span class="variable">modify</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Checks if a certain path was initialized</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  path</p></li><li><p><strong>returns</strong>: <em>Boolean</em></p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">isInit</span> = <span class="keyword">function</span> (<span class="variable">path</span>) {
  <span class="keyword">return</span> (<span class="variable">path</span> <span class="keyword">in</span> <span class="this">this</span>.<span class="variable">_activePaths</span>.<span class="variable">states</span>.<span class="variable">init</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Checks if a path was selected.
## </p>

<ul><li><p><strong>param</strong>: <em>String</em>  path</p></li><li><p><strong>return</strong>: <em>Boolean</em></p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">isSelected</span> = <span class="keyword">function</span> <span class="variable">isSelected</span> (<span class="variable">path</span>) {
  <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">_selected</span>) {

    <span class="keyword">if</span> (<span class="string">'_id'</span> === <span class="variable">path</span>) {
      <span class="keyword">return</span> <span class="number integer">0</span> !== <span class="this">this</span>.<span class="variable">_selected</span>.<span class="variable">_id</span>;
    }

    <span class="keyword">var</span> <span class="variable">paths</span> = <span class="class">Object</span>.<span class="variable">keys</span>(<span class="this">this</span>.<span class="variable">_selected</span>)
      , <span class="variable">i</span> = <span class="variable">paths</span>.<span class="variable">length</span>
      , <span class="variable">inclusive</span> = <span class="variable">false</span>
      , <span class="variable">cur</span>

    <span class="keyword">if</span> (<span class="number integer">1</span> === <span class="variable">i</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="string">'_id'</span> === <span class="variable">paths</span>[<span class="number integer">0</span>]) {
      <span class="comment">// only _id was selected.</span>
      <span class="keyword">return</span> <span class="number integer">0</span> === <span class="this">this</span>.<span class="variable">_selected</span>.<span class="variable">_id</span>;
    }

    <span class="keyword">while</span> (<span class="variable">i</span>--) {
      <span class="variable">cur</span> = <span class="variable">paths</span>[<span class="variable">i</span>];
      <span class="keyword">if</span> (<span class="string">'_id'</span> == <span class="variable">cur</span>) <span class="keyword">continue</span>;
      <span class="variable">inclusive</span> = !! <span class="this">this</span>.<span class="variable">_selected</span>[<span class="variable">cur</span>];
      <span class="keyword">break</span>;
    }

    <span class="keyword">if</span> (<span class="variable">path</span> <span class="keyword">in</span> <span class="this">this</span>.<span class="variable">_selected</span>) {
      <span class="keyword">return</span> <span class="variable">inclusive</span>;
    }

    <span class="variable">i</span> = <span class="variable">paths</span>.<span class="variable">length</span>;

    <span class="keyword">while</span> (<span class="variable">i</span>--) {
      <span class="variable">cur</span> = <span class="variable">paths</span>[<span class="variable">i</span>];
      <span class="keyword">if</span> (<span class="string">'_id'</span> == <span class="variable">cur</span>) <span class="keyword">continue</span>;

      <span class="keyword">if</span> (<span class="number integer">0</span> === <span class="variable">cur</span>.<span class="variable">indexOf</span>(<span class="variable">path</span> + <span class="string">'.'</span>)) {
        <span class="keyword">return</span> <span class="variable">inclusive</span>;
      }

      <span class="keyword">if</span> (<span class="number integer">0</span> === (<span class="variable">path</span> + <span class="string">'.'</span>).<span class="variable">indexOf</span>(<span class="variable">cur</span>)) {
        <span class="keyword">return</span> <span class="variable">inclusive</span>;
      }
    }

    <span class="keyword">return</span> ! <span class="variable">inclusive</span>;
  }

  <span class="keyword">return</span> <span class="variable">true</span>;
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Validation middleware</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  next</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Document</span>.<span class="variable">prototype</span>.<span class="variable">validate</span> = <span class="keyword">function</span> (<span class="variable">next</span>) {
  <span class="keyword">var</span> <span class="variable">total</span> = <span class="number integer">0</span>
    , <span class="variable">self</span> = <span class="this">this</span>
    , <span class="variable">validating</span> = {}

  <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">_activePaths</span>.<span class="variable">some</span>(<span class="string">'require'</span>, <span class="string">'init'</span>, <span class="string">'modify'</span>)) {
    <span class="keyword">return</span> <span class="variable">complete</span>();
  }

  <span class="keyword">function</span> <span class="variable">complete</span> () {
    <span class="variable">next</span>(<span class="variable">self</span>.<span class="variable">_validationError</span>);
    <span class="variable">self</span>.<span class="variable">_validationError</span> = <span class="keyword">null</span>;
  }

  <span class="this">this</span>.<span class="variable">_activePaths</span>.<span class="variable">forEach</span>(<span class="string">'require'</span>, <span class="string">'init'</span>, <span class="string">'modify'</span>, <span class="keyword">function</span> <span class="variable">validatePath</span> (<span class="variable">path</span>) {
    <span class="keyword">if</span> (<span class="variable">validating</span>[<span class="variable">path</span>]) <span class="keyword">return</span>;

    <span class="variable">validating</span>[<span class="variable">path</span>] = <span class="variable">true</span>;
    <span class="variable">total</span>++;

    <span class="variable">process</span>.<span class="variable">nextTick</span>(<span class="keyword">function</span>(){
      <span class="keyword">var</span> <span class="variable">p</span> = <span class="variable">self</span>.<span class="variable">schema</span>.<span class="variable">path</span>(<span class="variable">path</span>);
      <span class="keyword">if</span> (!<span class="variable">p</span>) <span class="keyword">return</span> --<span class="variable">total</span> || <span class="variable">complete</span>();

      <span class="variable">p</span>.<span class="variable">doValidate</span>(<span class="variable">self</span>.<span class="variable">getValue</span>(<span class="variable">path</span>), <span class="keyword">function</span> (<span class="variable">err</span>) {
        <span cla